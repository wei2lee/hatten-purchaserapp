<script src="lib/jquery/dist/jquery.min.js"></script>

<script>
    
//    var apiBase = 'http://prosalesdemo.infradesign.com.my/';
//    var apiBase = 'http://salesplatform.infradesign.com.my/';
    var apiBase = 'http://103.9.149.59:8034/';
    var apiDataBase = 'http://103.9.149.59:8034/data/HATT/';
    var token = '';
    
    function processError(jqXHR, textStatus, errorThrown) {
        var msg = null;
        if(jqXHR.responseJSON != null) {
            var json = jqXHR.responseJSON;
            if(!msg && json.error_description != null) {
                msg = json.error_description;
            }
            if(!msg && json.error != null) {
                msg = json.error; 
            }
            if(!msg && json.Message != null) {
                msg = json.Message;   
            }
            if(!msg) {
                msg = "Unable to interprete server reply";   
            }
        }else{
            msg = errorThrown; 
            if(!msg && jqXHR.status == 0) {
                msg = "Unable to connect to server";   
            }
            if(!msg) {
                msg = "Unable to interprete server reply";  
            }
        }
        return msg;
    }
    
    function login() {
        return $.ajax(apiBase + 'Token',{
            method:'POST',
            dataType:'json',
            data:{
                username:'90731C01@hatt',
                password:'F2568907B18C',
                grant_type:'password'
            }
        }).done(function(data, textStatus, jqXHR) { 
            console.log('done@' + this.url);
            console.log(data);
            token = data;
            return data;
        }).fail (function(jqXHR, textStatus, errorThrown) {
            console.log('fail@' + this.url);
            console.log(processError(jqXHR, textStatus, errorThrown));
        });
    }
    
    function getCompanySetting() {
        return $.ajax(apiBase + 'api/Company/Settings',{
            headers:{Authorization:'Bearer '+token.access_token},
            method:'GET',
            dataType:'json'
        }).done(function(data, textStatus, jqXHR) { 
            console.log('done@' + this.url);
            console.log(data);
            return data;
        }).fail (function(jqXHR, textStatus, errorThrown) {
            console.log('fail@' + this.url);
            console.log(processError(jqXHR, textStatus, errorThrown));
        });  
    }
    
    function getProjects() {
        return $.ajax(apiBase + 'api/Project',{
            headers:{Authorization:'Bearer '+token.access_token},
            method:'GET',
            dataType:'json'
        }).done(function(data, textStatus, jqXHR) { 
            console.log('done@' + this.url);
            console.log(data);
            return data;
        }).fail (function(jqXHR, textStatus, errorThrown) {
            console.log('fail@' + this.url);
            console.log(processError(jqXHR, textStatus, errorThrown));
        });  
    }
    
    function getAppProjects() {
        return $.ajax(apiBase + 'api/AppProject',{
            headers:{Authorization:'Bearer '+token.access_token},
            method:'GET',
            dataType:'json'
        }).done(function(data, textStatus, jqXHR) { 
            console.log('done@' + this.url);
            console.log(data);
            return data;
        }).fail (function(jqXHR, textStatus, errorThrown) {
            console.log('fail@' + this.url);
            console.log(processError(jqXHR, textStatus, errorThrown));
        });  
    }
    
    function getAppProjectById(id) {
        return $.ajax(apiBase + 'api/AppProject/'+id,{
            headers:{Authorization:'Bearer '+token.access_token},
            method:'GET',
            dataType:'json'
        }).done(function(data, textStatus, jqXHR) { 
            console.log('done@' + this.url);
            console.log(data);
            return data;
        }).fail (function(jqXHR, textStatus, errorThrown) {
            console.log('fail@' + this.url);
            console.log(processError(jqXHR, textStatus, errorThrown));
        });  
    }
    
    login().then(function() {
        return getCompanySetting(); 
    }).then(function(){
        return getProjects(); 
    }).then(function(){
        return getAppProjects().then(function(results){
            $.each(results, function(ind,appProject){
                getAppProjectById(appProject.Id);
            });
        });
    })
    
</script>